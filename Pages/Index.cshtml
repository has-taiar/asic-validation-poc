@page
@model IndexModel
@{
    ViewData["Title"] = "Home page";
}


<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Search Licensed Essential Services Companies (VIC)</h2>
        <div class="btn-group">
            <a href="/api/company/export-csv" class="btn btn-success" download>
                <i class="bi bi-download"></i> Quick Export CSV
            </a>
            <a href="/api/company/export-csv?enriched=true" class="btn btn-outline-success" download>
                <i class="bi bi-download"></i> Detailed Export CSV
            </a>
        </div>
    </div>
    
    <div class="alert alert-info">
        <strong>Export Options:</strong>
        <ul class="mb-0">
            <li><strong>Quick Export:</strong> Basic company data (fast)</li>
            <li><strong>Detailed Export:</strong> Includes ACN and additional details (slower, first 50 companies)</li>
        </ul>
    </div>
    
    <form id="searchForm" class="mb-3">
        <div class="input-group">
            <input type="text" class="form-control" id="searchInput" placeholder="Enter company name..." />
            <button type="submit" class="btn btn-primary">Search</button>
        </div>
    </form>
    
    <div class="mb-3">
        <small class="text-muted">
            Search for companies by name or trading name. Leave empty and search to see all companies.
        </small>
    </div>
    
    <div id="results"></div>
    <div id="loading" class="d-none">
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Searching companies...</p>
        </div>
    </div>
</div>

<script>
    document.getElementById('searchForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        const query = document.getElementById('searchInput').value;
        if (!query) return;
        
        const resultsDiv = document.getElementById('results');
        const loadingDiv = document.getElementById('loading');
        
        // Show loading
        loadingDiv.classList.remove('d-none');
        resultsDiv.innerHTML = '';
        
        try {
            const res = await fetch(`/api/company/search?query=${encodeURIComponent(query)}`);
            const data = await res.json();
            
            // Hide loading
            loadingDiv.classList.add('d-none');
            
            if (data.length === 0) {
                resultsDiv.innerHTML = '<div class="alert alert-warning">No companies found matching your search.</div>';
                return;
            }
            
            resultsDiv.innerHTML = '<h4>Search Results (' + data.length + ' found)</h4>' +
                '<div class="list-group">' +
                data.map(c => `
                    <a href="/CompanyDetails?name=${encodeURIComponent(c.name)}" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">${c.name}</h5>
                            <small>${c.licenseType || 'License Type Not Available'}</small>
                        </div>
                        ${c.tradingAs ? `<p class="mb-1"><strong>Trading As:</strong> ${c.tradingAs}</p>` : ''}
                        ${c.licenseDate ? `<small><strong>License Date:</strong> ${c.licenseDate}</small>` : ''}
                    </a>
                `).join('') +
                '</div>';
        } catch (error) {
            loadingDiv.classList.add('d-none');
            resultsDiv.innerHTML = '<div class="alert alert-danger">Error searching companies. Please try again.</div>';
            console.error('Search error:', error);
        }
    });
</script>
